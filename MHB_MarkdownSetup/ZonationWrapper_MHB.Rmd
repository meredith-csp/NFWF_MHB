---
title: "Conservation Prioritization Tool for the Missouri Headwaters Basin"
date: "last updated 03/01/2018"
output: html_notebook
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

***
**This tool is designed to help identify priority subwatersheds in the Missouri Headwaters Basin where there is potential for a conservation action of interest to provide the greatest net benefits to multiple conservation targets. 
Start by selecting your conservation action of interest, then assign weights to conservation targets that are linked to that action, based on their relative importance to you. When the prioritization process is finished, you can use the interactive map and plots to explore the results.**

***
*This custom decision support tool was developed by [The Center for Large Landscape Conservation](http://www.largelandscapes.org) and [Conservation Science Partners](http://www.csp-inc.org), with funding from [The National Fish & Wildlife Foundation](http://www.nfwf.org). The prioritization is run using [Zonation 4.0](https://www.helsinki.fi/en/researchgroups/metapopulation-research-centre/software#section-14300) and an adaptation of the [zonator](https://github.com/cbig/zonator) package for R.*

***

### Prioritization Settings

```{r include=FALSE}
if (!require("pacman")) install.packages("pacman",repos = "http://cran.us.r-project.org")
  pacman::p_load(zonator, raster, rgdal, leaflet)
source('create_zproject_rev.R')  
```

```{r globalfiles, echo=FALSE, warning=FALSE}
targ.summ<-read.csv("runs/data/actiontargets.csv",header=T)
act.lyrs<-read.csv("runs/data/actionlayers.csv",header=T)
mhb <- shapefile("runs/data/MissouriHeadwaters_HUC6/MissouriHeadwaters_HUC6.shp")
huc12 <- shapefile("runs/data/MissouriHeadwaters_HUC12/MissouriHeadwaters_HUC12.shp")
```

```{r eruptions, echo=FALSE, warning=TRUE}
fluidPage(sidebarLayout(
  sidebarPanel(
    wellPanel(
      textInput("run.name","Give your prioritization a name:","e.g., 'MyAction_Run1'"),
  
      radioButtons("action.sel", "Select Action of Interest:",
                   c("Private land protection" = "option1",
                     "Widen road culverts/bridges" = "option2",
                     "Decommission Roads" = "option3",
                     "Reduce grazing pressure" = "option4",
                     "Switch to flood irrigation" = "option5",
                     "Manage soil health" = "option6",
                     "Stream/riparian restoration" = "option7",
                     "Prescribed fire/thinning" = "option8",
                     "Encroachment prevention" = "option9"
                    )
      )
    ),
  
    wellPanel(
      actionButton("load.inputs", "Load last-used settings") 
    ),
    
    wellPanel(
      actionButton("save.settings", "Save run settings"),
      textOutput("save.confirm")
    ),
  
    wellPanel(
      actionButton("run.tool", "Run prioritization"),
      textOutput("please.wait"),
      textOutput("save.error")
    ),
    wellPanel(
      actionButton("check.stat","Check run status"),
      textOutput("stat.running"),
      textOutput("stat.done")
    )
  ),
  
  mainPanel(
      wellPanel(
          h5("Set weights for each target:"),
          uiOutput("wt.sel")
      ),
      wellPanel(tags$style(type = "text/css", "#map {height: calc(100vh - 80px) !important;}"),
                            leafletOutput('map'))
      )
  )
)

output$wt.sel <- renderUI({
      targets<-targ.summ[targ.summ[,input$action.sel]!=0,"name"]
      lapply(1:length(targets), function(i) {
        if(length(input$action.sel)==0) {output$wt.sel0 <- renderText({" "})} else {
        sliderInput(inputId=paste0("targ",i),label=targets[i],min=0,max=1,value=0,step=0.1)}
        })
})

output$map <- renderLeaflet({
      leaflet(mhb) %>%
        addProviderTiles("Esri.WorldTopoMap", group="Topographical") %>%
        addProviderTiles("Esri.WorldImagery", group="Satellite") %>%
        addPolygons(data=huc12, fill = FALSE, color = "#a9a9a9", weight = 1, opacity = 0.8) %>%
        addPolygons(fill = FALSE, color = "#8b3a3a", weight = 4, opacity = 0.8) %>%
        #addLegend("bottomright", pal = pal, values = ~y, title = "Temp C" , opacity = 0.9) %>%
        addLegend("bottomright", colors = c("#8b3a3a", "#a9a9a9"), opacity = 0.8, labels = c("Missouri Headwaters Basin", "HUC12 units")) %>%
        addLayersControl(baseGroup = c("Topographical", "Satellite")) %>%
        setView(lng = -112.219, lat = 45.324,  zoom = 8)  
    })

observeEvent(input$load.inputs,{   
    if(!file.exists('runs/lastinputs.RDS')) {return(NULL)}
    
    savedInputs <- readRDS('runs/lastinputs.RDS')
    inputIDs      <- names(savedInputs) 
    inputvalues   <- unlist(savedInputs) 
    
    for (i in 1:length(savedInputs)) { 
      session$sendInputMessage(inputIDs[i],  list(value=inputvalues[[i]]) )
    }
  })
  
  observeEvent(input$save.settings,{ 
    saveRDS(reactiveValuesToList(input), file = 'runs/lastinputs.RDS')

    project_path<-file.path("MHB_MarkdownSetup")
    variant_name<-input$run.name
    input_raster_dir<-"runs/data/TargetCondition"
    
    create_zproject_rev(name="runs",dir=".",variants=variant_name,
                    spp_template_dir=input_raster_dir,spp_file_pattern="*.tif",   
                    overwrite=T,
                    weight=c(input$targ1,input$targ2,input$targ3,input$targ4,input$targ5,input$targ6,input$targ7,input$targ8))

    dat<-list("Settings" = list("removal rule"=2, "edge removal"=1, 
                            "use planning unit layer"=1, "planning unit layer file"=paste0(getwd(), .Platform$file.sep,"runs",.Platform$file.sep,"data",.Platform$file.sep,"ZonationData",.Platform$file.sep,"HUC12_zones_30m_NAD83UTMint.tif"),
                            "use cost"=0, 
                            "use mask"=0, #"mask file"=paste0(getwd(), .Platform$file.sep, "runs",.Platform$file.sep,"data", .Platform$file.sep,"ActionMasks", .Platform$file.sep, act.lyrs[act.lyrs[,'label']==input$action.sel, "masklyr"]),
                            "use tree connectivity"=0)) #, "tree connectivity file"=paste0(getwd(), .Platform$file.sep,"data", .Platform$file.sep, "ZonationData", .Platform$file.sep, "MHB_tree_file.txt"))
    write_dat(dat,paste0("./runs/",variant_name,"/",variant_name,".dat"),overwrite=T)
    
    output$save.confirm <- renderText ({"Your settings have been saved. Now run it!"})
  })  
  
  # Run Zonation from shell upon user input
  observeEvent(input$run.tool,{
    project_path<-file.path("runs")
    variant_name<-input$run.name

    if (file.exists(paste0("./runs/",variant_name,".bat"))) {
      shell.exec(paste0("runs\\",  
                        variant_name,".bat"))
      output$please.wait<-renderText({paste("Please wait while your prioritization is run. Your results will appear below and will be saved to 'runs/",input$run.name,"'.",sep="")})
    }
    else{
      output$save.error <- renderText({"You must first select and save your run settings"})
    }
  })
    
  # Give run status update on request
  observeEvent(input$check.stat,{
    project_path<-file.path("runs")
    variant_name<-input$run.name

    if (file.exists(paste0("./runs/",variant_name,"/",variant_name,".ABF_ME.wrscr.compressed.tif"))) {
      output$stat.done<-renderText({paste("Your prioritization is done! Explore your results below.",sep="")})
    }
    else{
      output$stat.running <- renderText({"Your prioritization is still in progress. Please wait."})
    }
  })
```

***

*Contact: [Tyler Creech](tyler@largelandscapes.org), [Meredith McClure](meredith@csp-inc.org)*

***
